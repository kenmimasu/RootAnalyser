import numpy as np
import copy
from operator import attrgetter
from scipy.stats import norm
from util import locate_2D

def btag_probability(*particles, **kwargs):
    WP = kwargs.get('working_point', CSV_M)
    
    xedges, yedges, eff = WP['pt_edges'], WP['eta_edges'], WP['eff']
    
    result = []
    for p in particles:
        pti, etai = p.pt, p.eta
        ieff = locate_2D(pti, etai, xedges, yedges)
        try:
            result.append(eff[ieff])
        except IndexError:
            result.append(1.)
    
    return result[0] if (len(result)==1) else tuple(result) 
#

CSV_M = {
    'eta_edges': [
      -2.400, -2.274, -2.147, -2.021, -1.895, -1.768, -1.642, -1.516, -1.389, 
      -1.263, -1.137, -1.011, -0.884, -0.758, -0.632, -0.505, -0.379, -0.253, 
      -0.126,  0.000,  0.126,  0.253,  0.379,  0.505,  0.632,  0.758,  0.884, 
       1.011,  1.137,  1.263,  1.389,  1.516,  1.642,  1.768,  1.895,  2.021, 
       2.147, 2.274, 2.400
    ],

    'pt_edges' : [
      20., 30., 40., 50., 60., 70., 80., 90., 100., 110., 120., 130., 140., 
      150., 162., 180., 200., 225., 250., 975
    ],

    'eff': [
      # pt -->                                                            eta |
      #                                                                       V
      0.333, 0.392, 0.428, 0.441, 0.485, 0.492, 0.514, 0.537, 0.551, 0.559, 0.562, 0.569, 0.567, 0.570, 0.569, 0.565, 0.561, 0.558, 0.537, 
      0.435, 0.486, 0.502, 0.525, 0.546, 0.567, 0.575, 0.594, 0.596, 0.604, 0.608, 0.609, 0.612, 0.612, 0.609, 0.608, 0.600, 0.595, 0.577, 
      0.478, 0.538, 0.566, 0.578, 0.593, 0.605, 0.613, 0.624, 0.628, 0.634, 0.636, 0.637, 0.637, 0.638, 0.634, 0.631, 0.623, 0.616, 0.599, 
      0.510, 0.568, 0.595, 0.611, 0.622, 0.628, 0.638, 0.645, 0.648, 0.652, 0.652, 0.653, 0.653, 0.654, 0.650, 0.645, 0.637, 0.632, 0.612, 
      0.525, 0.587, 0.615, 0.625, 0.637, 0.645, 0.652, 0.656, 0.659, 0.662, 0.663, 0.663, 0.663, 0.663, 0.659, 0.654, 0.646, 0.640, 0.618, 
      0.538, 0.596, 0.624, 0.637, 0.647, 0.654, 0.660, 0.665, 0.667, 0.669, 0.669, 0.670, 0.669, 0.669, 0.665, 0.659, 0.650, 0.644, 0.622, 
      0.545, 0.613, 0.639, 0.652, 0.662, 0.667, 0.673, 0.675, 0.677, 0.679, 0.678, 0.678, 0.677, 0.677, 0.672, 0.666, 0.658, 0.651, 0.627, 
      0.554, 0.618, 0.645, 0.659, 0.668, 0.673, 0.678, 0.681, 0.683, 0.684, 0.683, 0.684, 0.681, 0.682, 0.677, 0.670, 0.661, 0.651, 0.624, 
      0.561, 0.630, 0.658, 0.670, 0.679, 0.683, 0.688, 0.690, 0.691, 0.692, 0.690, 0.691, 0.688, 0.688, 0.682, 0.676, 0.666, 0.655, 0.630, 
      0.575, 0.644, 0.675, 0.686, 0.695, 0.698, 0.702, 0.702, 0.702, 0.702, 0.701, 0.700, 0.697, 0.697, 0.691, 0.683, 0.673, 0.660, 0.634, 
      0.588, 0.661, 0.692, 0.704, 0.712, 0.712, 0.715, 0.715, 0.714, 0.713, 0.710, 0.710, 0.707, 0.706, 0.700, 0.692, 0.680, 0.665, 0.639, 
      0.599, 0.675, 0.708, 0.719, 0.725, 0.725, 0.729, 0.725, 0.723, 0.724, 0.720, 0.717, 0.714, 0.714, 0.708, 0.698, 0.686, 0.675, 0.646, 
      0.605, 0.684, 0.717, 0.729, 0.736, 0.734, 0.735, 0.735, 0.732, 0.729, 0.727, 0.724, 0.720, 0.721, 0.713, 0.704, 0.690, 0.674, 0.650, 
      0.609, 0.691, 0.724, 0.738, 0.742, 0.742, 0.742, 0.741, 0.736, 0.734, 0.732, 0.730, 0.724, 0.725, 0.718, 0.707, 0.692, 0.678, 0.642, 
      0.614, 0.695, 0.729, 0.742, 0.749, 0.746, 0.747, 0.744, 0.741, 0.739, 0.735, 0.733, 0.726, 0.728, 0.720, 0.710, 0.696, 0.682, 0.647, 
      0.613, 0.696, 0.730, 0.743, 0.749, 0.749, 0.749, 0.747, 0.742, 0.739, 0.734, 0.732, 0.727, 0.729, 0.720, 0.711, 0.696, 0.676, 0.643, 
      0.609, 0.690, 0.725, 0.737, 0.744, 0.744, 0.746, 0.743, 0.739, 0.736, 0.733, 0.729, 0.729, 0.726, 0.719, 0.708, 0.693, 0.678, 0.637, 
      0.602, 0.687, 0.721, 0.734, 0.741, 0.741, 0.742, 0.738, 0.737, 0.735, 0.731, 0.726, 0.723, 0.724, 0.716, 0.706, 0.691, 0.675, 0.636, 
      0.596, 0.677, 0.712, 0.725, 0.731, 0.733, 0.735, 0.732, 0.731, 0.729, 0.726, 0.723, 0.720, 0.720, 0.713, 0.702, 0.687, 0.671, 0.627, 
      0.594, 0.677, 0.712, 0.724, 0.732, 0.732, 0.734, 0.732, 0.730, 0.728, 0.727, 0.722, 0.720, 0.719, 0.712, 0.701, 0.686, 0.670, 0.630, 
      0.602, 0.684, 0.719, 0.731, 0.739, 0.738, 0.739, 0.738, 0.735, 0.733, 0.730, 0.727, 0.724, 0.724, 0.715, 0.705, 0.690, 0.674, 0.635, 
      0.609, 0.690, 0.725, 0.738, 0.743, 0.744, 0.745, 0.742, 0.741, 0.738, 0.732, 0.732, 0.727, 0.726, 0.720, 0.708, 0.694, 0.680, 0.637, 
      0.613, 0.695, 0.731, 0.742, 0.749, 0.748, 0.747, 0.742, 0.741, 0.738, 0.733, 0.733, 0.728, 0.727, 0.721, 0.710, 0.696, 0.681, 0.641, 
      0.614, 0.695, 0.729, 0.741, 0.747, 0.747, 0.747, 0.743, 0.742, 0.737, 0.735, 0.731, 0.727, 0.727, 0.721, 0.709, 0.695, 0.683, 0.644, 
      0.610, 0.690, 0.725, 0.736, 0.742, 0.742, 0.743, 0.740, 0.738, 0.734, 0.730, 0.730, 0.724, 0.724, 0.717, 0.708, 0.693, 0.681, 0.644, 
      0.608, 0.687, 0.720, 0.730, 0.738, 0.739, 0.738, 0.736, 0.733, 0.731, 0.727, 0.725, 0.721, 0.722, 0.714, 0.705, 0.691, 0.679, 0.645, 
      0.606, 0.684, 0.717, 0.728, 0.733, 0.734, 0.734, 0.734, 0.729, 0.727, 0.725, 0.722, 0.718, 0.718, 0.712, 0.703, 0.689, 0.676, 0.639, 
      0.597, 0.671, 0.702, 0.714, 0.720, 0.722, 0.724, 0.722, 0.721, 0.719, 0.716, 0.717, 0.711, 0.712, 0.705, 0.696, 0.685, 0.673, 0.642, 
      0.584, 0.655, 0.686, 0.697, 0.705, 0.707, 0.710, 0.710, 0.709, 0.708, 0.706, 0.706, 0.702, 0.703, 0.696, 0.688, 0.677, 0.666, 0.640, 
      0.570, 0.641, 0.670, 0.682, 0.690, 0.693, 0.697, 0.697, 0.698, 0.698, 0.697, 0.696, 0.692, 0.694, 0.687, 0.680, 0.670, 0.659, 0.629, 
      0.559, 0.627, 0.655, 0.666, 0.675, 0.679, 0.684, 0.686, 0.687, 0.688, 0.687, 0.687, 0.685, 0.686, 0.680, 0.673, 0.664, 0.655, 0.631, 
      0.556, 0.616, 0.646, 0.658, 0.667, 0.672, 0.677, 0.680, 0.681, 0.682, 0.682, 0.682, 0.680, 0.680, 0.675, 0.670, 0.661, 0.651, 0.634, 
      0.547, 0.610, 0.636, 0.649, 0.659, 0.664, 0.670, 0.673, 0.675, 0.676, 0.676, 0.676, 0.675, 0.675, 0.670, 0.665, 0.656, 0.647, 0.628, 
      0.537, 0.593, 0.619, 0.631, 0.643, 0.648, 0.657, 0.661, 0.663, 0.666, 0.666, 0.667, 0.666, 0.666, 0.662, 0.657, 0.650, 0.642, 0.618, 
      0.522, 0.576, 0.607, 0.617, 0.630, 0.638, 0.646, 0.650, 0.654, 0.656, 0.657, 0.658, 0.658, 0.658, 0.655, 0.649, 0.643, 0.635, 0.615, 
      0.498, 0.554, 0.581, 0.595, 0.610, 0.618, 0.628, 0.633, 0.638, 0.643, 0.644, 0.645, 0.646, 0.646, 0.642, 0.639, 0.631, 0.627, 0.606, 
      0.455, 0.508, 0.533, 0.557, 0.573, 0.583, 0.596, 0.607, 0.615, 0.619, 0.620, 0.623, 0.624, 0.625, 0.621, 0.617, 0.611, 0.605, 0.586, 
      0.385, 0.422, 0.463, 0.481, 0.511, 0.533, 0.545, 0.561, 0.569, 0.577, 0.583, 0.584, 0.589, 0.589, 0.589, 0.583, 0.579, 0.574, 0.554
    ]
}

